<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapSpend</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- jsPDF & AutoTable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Animations */
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .scan-beam {
            animation: scan 2s ease-in-out infinite;
        }
        
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Smooth transitions */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen pb-24">

    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-20 safe-top">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i data-lucide="camera" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">SnapSpend</h1>
            </div>
            <!-- Settings Button -->
            <button id="settings-btn" class="p-2 bg-indigo-500 rounded-full hover:bg-indigo-400 transition-colors shadow-sm">
                <i data-lucide="settings" class="w-5 h-5 text-white"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">
        
        <!-- Total Card -->
        <div class="bg-gradient-to-br from-indigo-600 to-violet-700 rounded-2xl p-6 text-white shadow-xl mb-6 relative overflow-hidden">
            <div class="relative z-10">
                <span class="text-indigo-200 text-sm font-medium uppercase tracking-wider">Total Spent</span>
                <div class="flex items-baseline mt-1">
                    <span id="currency-symbol" class="text-2xl mr-1 font-medium">₹</span>
                    <span id="total-amount" class="text-4xl font-bold">0.00</span>
                </div>
                <div class="mt-4 flex items-center gap-2 text-indigo-100 text-sm">
                    <div class="bg-white/20 p-1 rounded">
                        <i data-lucide="calendar" class="w-3 h-3"></i>
                    </div>
                    <span id="transaction-count">0 transactions recorded</span>
                </div>
            </div>
            <!-- Decorative circles -->
            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
            <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-500/30 rounded-full blur-xl"></div>
        </div>

        <!-- Filters & Controls -->
        <div class="mb-5">
            <div class="flex justify-between items-end px-1 mb-2">
                <h2 class="font-bold text-gray-800 text-lg">Transactions</h2>
            </div>
            
            <div class="flex gap-2 items-center">
                <!-- Category Dropdown -->
                <div class="relative flex-1">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                    </div>
                    <select id="category-select" class="w-full pl-10 pr-8 py-3 bg-white border border-gray-200 rounded-xl appearance-none text-sm font-medium text-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm transition-all">
                        <option value="All">All Categories</option>
                        <option value="Food & Dining">Food & Dining</option>
                        <option value="Groceries">Groceries</option>
                        <option value="Transport">Transport</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Health">Health</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>

                <!-- Sort Button -->
                <button id="sort-btn" class="flex-shrink-0 w-11 h-11 flex items-center justify-center bg-white border border-gray-200 rounded-xl text-gray-600 shadow-sm hover:bg-gray-50 active:scale-95 transition-all focus:ring-2 focus:ring-indigo-500 outline-none">
                    <i id="sort-icon" data-lucide="arrow-up-down" class="w-5 h-5"></i>
                </button>

                <!-- PDF Export Button -->
                <button id="export-btn" class="flex-shrink-0 w-11 h-11 flex items-center justify-center bg-rose-50 border border-rose-200 rounded-xl text-rose-600 shadow-sm hover:bg-rose-100 active:scale-95 transition-all focus:ring-2 focus:ring-rose-500 outline-none" title="Export PDF">
                    <i data-lucide="file-down" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="flex flex-col items-center justify-center py-12 px-4 text-center text-gray-500 hidden">
            <div class="bg-gray-100 p-6 rounded-full mb-4">
                <i data-lucide="pie-chart" class="w-12 h-12 text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-700">No expenses found</h3>
            <p class="text-sm max-w-[250px] mt-2">Try adjusting your filters or upload a new receipt.</p>
        </div>

        <!-- Expenses List Container -->
        <div id="expenses-list" class="space-y-1">
            <!-- Items injected via JS -->
        </div>

    </main>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-6 left-0 right-0 flex justify-center gap-4 z-30 pointer-events-none px-4">
        <!-- Manual Add Button -->
        <button id="manual-add-btn" class="pointer-events-auto flex items-center justify-center w-14 h-14 bg-white text-indigo-600 rounded-full shadow-xl hover:bg-gray-50 active:scale-95 transition-all border border-indigo-100">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

        <!-- Scan Button -->
        <input type="file" id="file-input" accept="image/*" class="hidden">
        <button id="scan-btn" class="pointer-events-auto group flex items-center gap-2 bg-gray-900 hover:bg-black text-white px-6 py-4 rounded-full shadow-2xl transition-all transform active:scale-95">
            <i data-lucide="upload" class="w-5 h-5 group-hover:-translate-y-1 transition-transform"></i>
            <span class="font-bold">Scan Receipt</span>
        </button>
    </div>

    <!-- Processing Overlay -->
    <div id="processing-view" class="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center text-white p-6 hidden fade-in">
        <div class="relative w-64 h-80 mb-8 rounded-2xl overflow-hidden shadow-2xl border-2 border-white/20">
            <img id="processing-img" src="" alt="Receipt" class="w-full h-full object-cover opacity-50">
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="relative">
                    <div class="absolute inset-0 bg-indigo-500 blur-xl opacity-50 animate-pulse"></div>
                    <i data-lucide="loader-2" class="relative z-10 w-12 h-12 animate-spin text-white"></i>
                </div>
            </div>
            <div class="absolute top-0 left-0 w-full h-1 bg-indigo-400 shadow-[0_0_15px_rgba(129,140,248,0.8)] scan-beam"></div>
        </div>
        <h2 class="text-2xl font-bold mb-2">Analyzing...</h2>
        <p class="text-gray-400 text-center max-w-xs">Gemini Vision is extracting details.</p>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-50 z-50 hidden flex-col h-full slide-up">
        <div class="bg-white p-4 shadow-sm flex justify-between items-center border-b shrink-0">
             <h2 class="font-semibold text-lg">Settings</h2>
             <button id="close-settings-btn" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                <i data-lucide="x" class="w-6 h-6"></i>
             </button>
        </div>
        <div class="p-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key</label>
            <input type="password" id="input-api-key" placeholder="Paste your API key here" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none mb-2">
            <p class="text-xs text-gray-500 mb-6">
                Required for receipt analysis. The key is stored locally in your browser. 
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline">Get a free key here</a>.
            </p>
            <button id="save-settings-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-colors shadow-md">
                Save Settings
            </button>
            <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                 <div class="inline-flex items-center gap-2 text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                    <i data-lucide="hard-drive" class="w-3 h-3"></i>
                    <span>Storage: Local Browser</span>
                 </div>
            </div>
        </div>
    </div>

    <!-- Edit/Verify Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-50 z-40 hidden flex-col h-full slide-up">
        <div class="bg-white p-4 shadow-sm flex justify-between items-center border-b shrink-0">
            <button id="close-edit-btn" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 id="modal-title" class="font-semibold text-lg">Verify Details</h2>
            <button id="save-btn" class="text-indigo-600 font-bold p-2 hover:bg-indigo-50 rounded-lg">Save</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-32">
            <!-- Image Preview Container -->
            <div id="preview-container" class="flex justify-center mb-6">
                <div class="w-32 h-32 rounded-xl overflow-hidden border border-gray-200 shadow-sm bg-gray-100">
                    <img id="edit-preview-img" src="" class="w-full h-full object-cover">
                </div>
            </div>

            <form id="expense-form" class="space-y-4 max-w-md mx-auto">
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Merchant</label>
                    <div class="relative">
                        <div class="absolute left-3 top-3.5 text-gray-400"><i data-lucide="store" class="w-5 h-5"></i></div>
                        <input type="text" id="input-merchant" placeholder="e.g. Starbucks" class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-gray-900">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Amount</label>
                        <div class="relative">
                            <span id="input-currency-label" class="absolute left-3 top-3.5 text-gray-500 font-bold">₹</span>
                            <input type="number" step="0.01" id="input-amount" placeholder="0.00" class="w-full pl-8 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-gray-900">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Date</label>
                        <input type="date" id="input-date" class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-gray-900">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Category</label>
                    <div class="relative">
                        <div class="absolute left-3 top-3.5 text-gray-400"><i data-lucide="tag" class="w-5 h-5"></i></div>
                        <select id="input-category" class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none appearance-none text-gray-900">
                            <option>Food & Dining</option>
                            <option>Groceries</option>
                            <option>Transport</option>
                            <option>Shopping</option>
                            <option>Utilities</option>
                            <option>Health</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Delete Transaction?</h3>
            <p class="text-gray-600 mb-6">This will permanently remove this expense from your history.</p>
            <div class="flex gap-3 justify-end">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-600 font-semibold hover:bg-gray-100 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white font-semibold hover:bg-red-600 rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <!-- Application Script (Local Storage + API) -->
    <script>
        // --- 1. LOCAL STORAGE HELPER ---
        const STORAGE_KEY = 'snapspend_expenses';
        const API_KEY_STORAGE = 'snapspend_api_key';

        function getStoredExpenses() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveExpensesToStorage(expenses) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
        }

        function getStoredApiKey() {
            return localStorage.getItem(API_KEY_STORAGE) || "";
        }

        function saveApiKey(key) {
            localStorage.setItem(API_KEY_STORAGE, key.trim());
        }

        function generateId() {
            return (typeof crypto !== 'undefined' && crypto.randomUUID) 
                ? crypto.randomUUID() 
                : 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // --- 2. STATE ---
        let expenses = getStoredExpenses(); // Load immediately
        let currentScannedData = null; 
        let itemToDeleteId = null;
        
        // Sorting & Filtering State
        let activeFilter = 'All';
        let sortMode = 'date'; // 'date' | 'amount-asc' | 'amount-desc'

        const categories = ['All', 'Food & Dining', 'Groceries', 'Transport', 'Shopping', 'Utilities', 'Health', 'Other'];

        // --- 3. DOM ELEMENTS ---
        const els = {
            totalAmount: document.getElementById('total-amount'),
            currencySymbol: document.getElementById('currency-symbol'),
            txCount: document.getElementById('transaction-count'),
            list: document.getElementById('expenses-list'),
            emptyState: document.getElementById('empty-state'),
            
            // Controls
            categorySelect: document.getElementById('category-select'),
            sortBtn: document.getElementById('sort-btn'),
            sortIcon: document.getElementById('sort-icon'),
            exportBtn: document.getElementById('export-btn'), 
            settingsBtn: document.getElementById('settings-btn'), // New Button

            fileInput: document.getElementById('file-input'),
            scanBtn: document.getElementById('scan-btn'),
            manualAddBtn: document.getElementById('manual-add-btn'),
            
            // Modals
            processingView: document.getElementById('processing-view'),
            processingImg: document.getElementById('processing-img'),
            editModal: document.getElementById('edit-modal'),
            settingsModal: document.getElementById('settings-modal'), // New Modal
            modalTitle: document.getElementById('modal-title'),
            previewContainer: document.getElementById('preview-container'),
            editPreviewImg: document.getElementById('edit-preview-img'),
            confirmModal: document.getElementById('confirm-modal'),
            
            // Form Inputs
            inputMerchant: document.getElementById('input-merchant'),
            inputAmount: document.getElementById('input-amount'),
            inputDate: document.getElementById('input-date'),
            inputCategory: document.getElementById('input-category'),
            inputCurrencyLabel: document.getElementById('input-currency-label'),
            inputApiKey: document.getElementById('input-api-key'), // New Input
            
            // Buttons
            closeEditBtn: document.getElementById('close-edit-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'), // New Btn
            saveBtn: document.getElementById('save-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'), // New Btn
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
        };

        // --- 4. CRUD OPERATIONS (Local) ---

        function addExpense(data) {
            const newItem = {
                id: generateId(),
                ...data,
                createdAt: new Date().toISOString()
            };
            expenses.unshift(newItem); // Add to beginning
            saveExpensesToStorage(expenses);
            renderUI();
            hideModal('edit-modal');
        }

        function deleteExpense() {
            if (!itemToDeleteId) return;
            expenses = expenses.filter(item => item.id !== itemToDeleteId);
            saveExpensesToStorage(expenses);
            renderUI();
            hideModal('confirm-modal');
            itemToDeleteId = null;
        }

        // --- 5. GEMINI AI ---
        async function analyzeReceipt(base64Image) {
            // Retrieve key from Local Storage or fallback to empty string
            const apiKey = getStoredApiKey();
            
            if (!apiKey) {
                alert("Please configure your Gemini API Key in Settings first.");
                openSettings();
                throw new Error("API Key missing");
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const base64Data = base64Image.split(',')[1];

            const prompt = `
                Analyze this receipt image and extract the following details into a JSON object. 
                Ensure the output is RAW JSON (no markdown code blocks).
                
                Fields required:
                - merchant: (string) Name of the store/restaurant.
                - date: (string) Date in YYYY-MM-DD format. If not found, use today's date.
                - amount: (number) Total amount.
                - currency: (string) Currency symbol (e.g., $, ₹, €).
                - category: (string) Infer one of: "Food & Dining", "Groceries", "Transport", "Shopping", "Utilities", "Health", "Other".
            `;

            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(!response.ok) {
                    if (response.status === 400 || response.status === 403) {
                         alert("Invalid API Key. Please check your settings.");
                    }
                    throw new Error("API Request failed: " + response.statusText);
                }

                const data = await response.json();
                const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResult) throw new Error("No AI response");
                
                return JSON.parse(textResult);
            } catch (error) {
                console.error("Gemini Error:", error);
                throw error;
            }
        }

        // --- 6. PDF EXPORT ---
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("PDF library not loaded yet.");
                return;
            }

            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(18);
            doc.text("SnapSpend Report", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            const dateStr = new Date().toLocaleDateString();
            doc.text(`Generated on ${dateStr}`, 14, 28);

            // Calculate current view data (respect filters)
            const currentData = activeFilter === 'All' 
                ? expenses 
                : expenses.filter(ex => ex.category === activeFilter);

            // Table Data
            const tableBody = currentData.map(item => [
                item.date,
                item.merchant,
                item.category,
                `${item.currency}${item.amount}`
            ]);

            // Total
            const total = currentData.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            const currency = currentData.length > 0 ? currentData[0].currency : '₹';

            doc.autoTable({
                startY: 35,
                head: [['Date', 'Merchant', 'Category', 'Amount']],
                body: tableBody,
                foot: [['', '', 'TOTAL', `${currency}${total.toFixed(2)}`]],
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] }, // Indigo-600
                footStyles: { fillColor: [241, 245, 249], textColor: [30, 41, 59], fontStyle: 'bold' }
            });

            doc.save(`SnapSpend_Report_${dateStr.replace(/\//g, '-')}.pdf`);
        }

        // --- 7. HELPER FUNCTIONS ---
        
        function getFriendlyDate(dateStr) {
            if (!dateStr) return 'Unknown Date';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            date.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            yesterday.setHours(0,0,0,0);

            if (date.getTime() === today.getTime()) return 'Today';
            if (date.getTime() === yesterday.getTime()) return 'Yesterday';
            
            return date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        function groupExpensesByDate(items) {
            const groups = {};
            items.forEach(item => {
                const dateKey = item.date || 'Unknown';
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(item);
            });
            return Object.keys(groups).sort((a, b) => b.localeCompare(a)).map(date => ({
                date: date,
                label: getFriendlyDate(date),
                items: groups[date]
            }));
        }

        function createExpenseCard(item) {
            let iconName = 'dollar-sign';
            let colorClass = 'bg-gray-100 text-gray-600';
            if (item.category === 'Food & Dining') { iconName = 'store'; colorClass = 'bg-orange-100 text-orange-600'; }
            else if (item.category === 'Groceries') { iconName = 'tag'; colorClass = 'bg-green-100 text-green-600'; }
            else if (item.category === 'Transport') { iconName = 'car'; colorClass = 'bg-blue-100 text-blue-600'; }

            return `
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center transition-all hover:shadow-md">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="p-3 rounded-lg flex-shrink-0 ${colorClass}">
                        <i data-lucide="${iconName}" class="w-5 h-5"></i>
                    </div>
                    <div class="min-w-0">
                        <h4 class="font-semibold text-gray-900 truncate">${item.merchant || 'Unknown'}</h4>
                        <div class="flex items-center text-xs text-gray-500 gap-2">
                            <span>${item.date}</span>
                            <span>•</span>
                            <span class="truncate">${item.category}</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3 flex-shrink-0">
                    <span class="font-bold text-gray-900 text-lg">
                        ${item.currency}${item.amount}
                    </span>
                    <button onclick="window.requestDelete('${item.id}')" class="text-gray-400 hover:text-red-500 p-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>`;
        }

        // --- 8. UI RENDERING ---
        function renderUI() {
            // Totals
            const total = expenses.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            els.totalAmount.textContent = total.toFixed(2);
            els.txCount.textContent = `${expenses.length} transactions recorded`;
            if (expenses.length > 0) els.currencySymbol.textContent = expenses[0].currency || '₹';
            
            // 1. FILTER
            let filteredExpenses = activeFilter === 'All' 
                ? [...expenses] 
                : expenses.filter(ex => ex.category === activeFilter);

            // 2. SORT
            // We clone to avoid mutating the original array order permanently if we switch back
            let sortedExpenses = [...filteredExpenses];
            
            if (sortMode === 'amount-asc') {
                sortedExpenses.sort((a, b) => (parseFloat(a.amount) || 0) - (parseFloat(b.amount) || 0));
                els.sortIcon.setAttribute('data-lucide', 'arrow-up-narrow-wide');
                els.sortBtn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
            } else if (sortMode === 'amount-desc') {
                sortedExpenses.sort((a, b) => (parseFloat(b.amount) || 0) - (parseFloat(a.amount) || 0));
                els.sortIcon.setAttribute('data-lucide', 'arrow-down-wide-narrow');
                els.sortBtn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
            } else {
                // Default: Date Desc
                sortedExpenses.sort((a, b) => b.date.localeCompare(a.date));
                els.sortIcon.setAttribute('data-lucide', 'arrow-up-down');
                els.sortBtn.classList.remove('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
            }

            // 3. RENDER LIST
            if (sortedExpenses.length === 0) {
                els.emptyState.classList.remove('hidden');
                els.list.innerHTML = '';
            } else {
                els.emptyState.classList.add('hidden');
                
                if (sortMode === 'date') {
                    // Group By Date
                    const groupedData = groupExpensesByDate(sortedExpenses);
                    els.list.innerHTML = groupedData.map(group => `
                        <div class="mb-5 animate-fade-in">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">${group.label}</h3>
                            <div class="space-y-3">
                                ${group.items.map(item => createExpenseCard(item)).join('')}
                            </div>
                        </div>
                    `).join('');
                } else {
                    // Flat List for Amount Sort
                    els.list.innerHTML = `
                        <div class="space-y-3 animate-fade-in">
                            ${sortedExpenses.map(item => createExpenseCard(item)).join('')}
                        </div>
                    `;
                }
                
                lucide.createIcons();
            }
        }

        // --- 9. EVENT HANDLERS ---
        
        function openSettings() {
            els.inputApiKey.value = getStoredApiKey();
            els.settingsModal.classList.remove('hidden');
            els.settingsModal.classList.add('flex');
        }

        // Settings Handlers
        els.settingsBtn.addEventListener('click', openSettings);
        
        els.closeSettingsBtn.addEventListener('click', () => {
            hideModal('settings-modal');
        });

        els.saveSettingsBtn.addEventListener('click', () => {
            saveApiKey(els.inputApiKey.value);
            hideModal('settings-modal');
            alert("Settings saved!");
        });

        // Manual Add Handler
        els.manualAddBtn.addEventListener('click', () => {
            currentScannedData = null;
            els.inputMerchant.value = '';
            els.inputAmount.value = '';
            els.inputDate.value = new Date().toISOString().split('T')[0];
            els.inputCategory.value = 'Food & Dining';
            els.inputCurrencyLabel.textContent = '₹'; 
            
            els.modalTitle.textContent = "Add Manual Expense";
            els.previewContainer.classList.add('hidden'); 
            
            els.editModal.classList.remove('hidden');
            els.editModal.classList.add('flex');
        });

        // Filter Dropdown Change
        els.categorySelect.addEventListener('change', (e) => {
            activeFilter = e.target.value;
            renderUI();
        });

        // Sort Toggle Click
        els.sortBtn.addEventListener('click', () => {
            if (sortMode === 'date') sortMode = 'amount-asc';
            else if (sortMode === 'amount-asc') sortMode = 'amount-desc';
            else sortMode = 'date';
            renderUI();
        });

        // Export PDF Click
        els.exportBtn.addEventListener('click', exportPDF);

        // Scan & Upload
        els.scanBtn.addEventListener('click', () => els.fileInput.click());
        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            
            // Check for key before doing heavy work
            if(!getStoredApiKey()){
                alert("Please set your Gemini API Key in Settings first.");
                openSettings();
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (evt) => {
                const base64 = evt.target.result;
                els.processingImg.src = base64;
                els.processingView.classList.remove('hidden');
                els.processingView.classList.add('flex');
                try {
                    const data = await analyzeReceipt(base64);
                    currentScannedData = { ...data, currency: data.currency || '₹' }; 
                    els.inputMerchant.value = data.merchant || '';
                    els.inputAmount.value = data.amount || '';
                    els.inputDate.value = data.date || new Date().toISOString().split('T')[0];
                    els.inputCategory.value = data.category || 'Other';
                    els.inputCurrencyLabel.textContent = currentScannedData.currency;
                    els.editPreviewImg.src = base64;
                    
                    els.modalTitle.textContent = "Verify Details";
                    els.previewContainer.classList.remove('hidden'); 
                    
                    els.processingView.classList.add('hidden');
                    els.processingView.classList.remove('flex');
                    els.editModal.classList.remove('hidden');
                    els.editModal.classList.add('flex');
                } catch (err) {
                    console.error(err);
                    alert("Analysis failed. Check your API key or internet connection.");
                    els.processingView.classList.add('hidden');
                    els.processingView.classList.remove('flex');
                }
            };
            reader.readAsDataURL(file);
            e.target.value = ''; 
        });

        els.closeEditBtn.addEventListener('click', () => hideModal('edit-modal'));
        els.saveBtn.addEventListener('click', () => {
            const payload = {
                merchant: els.inputMerchant.value || 'Unknown',
                amount: parseFloat(els.inputAmount.value) || 0,
                date: els.inputDate.value,
                category: els.inputCategory.value,
                currency: currentScannedData?.currency || '₹'
            };
            addExpense(payload);
        });

        els.cancelDeleteBtn.addEventListener('click', () => hideModal('confirm-modal'));
        els.confirmDeleteBtn.addEventListener('click', deleteExpense);

        window.requestDelete = (id) => {
            itemToDeleteId = id;
            els.confirmModal.classList.remove('hidden');
            els.confirmModal.classList.add('flex');
        };

        function hideModal(id) {
            const el = document.getElementById(id);
            el.classList.add('hidden');
            el.classList.remove('flex');
        }

        // --- 10. BOOTSTRAP ---
        lucide.createIcons();
        renderUI(); // Initial render

    </script>
</body>
</html>
